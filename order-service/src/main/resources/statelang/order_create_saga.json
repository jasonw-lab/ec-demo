{
  "Name": "order_create_saga",
  "Comment": "Init order -> reserve stock -> do payment via backend -> mark paid; on failure compensate stock & mark failed.",
  "Version": "1.0.0",
  "StartState": "InitOrder",
  "States": {
    "InitOrder": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "initOrderPending",
      "Input": [
        "$.[orderNo]",
        "$.[userId]",
        "$.[productId]",
        "$.[count]",
        "$.[amount]"
      ],
      "Status": {
        "#root == true": "SU",
        "#root == false": "FA",
        "$Exception{java.lang.Throwable}": "UN"
      },
      "CompensateState": "CancelOrderFailed",
      "Next": "ReserveStock"
    },
    "ReserveStock": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "storageDeduct",
      "Input": [
        "$.[orderNo]",
        "$.[productId]",
        "$.[count]"
      ],
      "Status": {
        "#root == true": "SU",
        "#root == false": "FA",
        "$Exception{java.lang.Throwable}": "UN"
      },
      "CompensateState": "ReleaseStock",
      "Next": "RequestPayment"
    },
    "RequestPayment": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "requestPayment",
      "Input": [
        "$.[orderNo]",
        "$.[amount]"
      ],
      "Status": {
        "#root == true": "SU",
        "#root == false": "FA",
        "$Exception{java.lang.Throwable}": "UN"
      },
      "Catch": [
        {
          "Exceptions": [
            "java.lang.Throwable"
          ],
          "Next": "CompensationTrigger"
        }
      ],
      "Next": "AwaitPayment"
    },
    "AwaitPayment": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "awaitPaymentResult",
      "Input": [
        "$.[orderNo]"
      ],
      "Status": {
        "#root == true": "SU",
        "#root == false": "FA",
        "$Exception{java.lang.Throwable}": "UN"
      },
      "Catch": [
        {
          "Exceptions": [
            "java.lang.Throwable"
          ],
          "Next": "CompensationTrigger"
        }
      ],
      "Next": "MarkPaid"
    },
    "MarkPaid": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "markPaid",
      "Input": [
        "$.[orderNo]"
      ],
      "Status": {
        "#root == true": "SU",
        "#root == false": "FA",
        "$Exception{java.lang.Throwable}": "UN"
      },
      "Next": "Succeed"
    },
    "ReleaseStock": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "storageCompensate",
      "Input": [
        "$.[orderNo]",
        "$.[productId]",
        "$.[count]"
      ]
    },
    "CancelOrderFailed": {
      "Type": "ServiceTask",
      "ServiceName": "orderSagaActions",
      "ServiceMethod": "markFailed",
      "Input": [
        "$.[orderNo]",
        "'PAYPAY_FAILED'",
        "'PayPay payment failed or timed out'"
      ]
    },
    "CompensationTrigger": {
      "Type": "CompensationTrigger",
      "Next": "Fail"
    },
    "Succeed": {
      "Type": "Succeed"
    },
    "Fail": {
      "Type": "Fail",
      "ErrorCode": "ORDER_CREATE_FAILED",
      "Message": "Compensation executed if needed."
    }
  }
}
