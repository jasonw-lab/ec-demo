<mxfile host="Electron" version="29.0.3" pages="1">
  <diagram id="ec-demo-kafka-alert-seq" name="ec-demo kafka-alert sequence">
    <mxGraphModel dx="2936" dy="1753" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="cBfdUd4junJDnaiCbnr2-1" value="ec-demo Kafka Alert Sequence (Single Sheet) — Rule A / Rule B / Rule C" style="text;html=1;strokeColor=none;fillColor=none;fontSize=18;fontStyle=1;whiteSpace=wrap;" parent="1" vertex="1">
          <mxGeometry x="-151" y="-17" width="1580" height="30" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-2" value="Client&#xa;(Front / BFF)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf" parent="1" vertex="1">
          <mxGeometry x="-151" y="33" width="160" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-3" value="Order Service&#xa;(ec-demo)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366" parent="1" vertex="1">
          <mxGeometry x="49" y="33" width="190" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-4" value="PayPay&#xa;(Webhook / Polling)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366" parent="1" vertex="1">
          <mxGeometry x="269" y="33" width="210" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-5" value="Kafka&#xa;Topics" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656" parent="1" vertex="1">
          <mxGeometry x="519" y="33" width="170" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-6" value="alert-service&#xa;(Kafka Streams)&#xa;※実装: alert-service" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" parent="1" vertex="1">
          <mxGeometry x="719" y="33" width="250" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-34" value="alert-service&#xa;(Consumer)&#xa;※実装: alert-service" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450" parent="1" vertex="1">
          <mxGeometry x="1070" y="33" width="250" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-36" value="MySQL&#xa;ec_system.sys_pay_alert" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6" vertex="1" parent="1">
          <mxGeometry x="1388" y="29" width="220" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-7" style="dashed=1;strokeColor=#999999" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-71" y="83" as="sourcePoint" />
            <mxPoint x="-71" y="1283" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-8" style="dashed=1;strokeColor=#999999" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="144" y="83" as="sourcePoint" />
            <mxPoint x="144" y="1283" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-9" style="dashed=1;strokeColor=#999999" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="374" y="83" as="sourcePoint" />
            <mxPoint x="374" y="1283" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-10" style="dashed=1;strokeColor=#999999" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="83" as="sourcePoint" />
            <mxPoint x="604" y="1283" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-11" style="dashed=1;strokeColor=#999999" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="83" as="sourcePoint" />
            <mxPoint x="844" y="1283" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-35" style="dashed=1;strokeColor=#999999" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1084" y="83" as="sourcePoint" />
            <mxPoint x="1088" y="1407" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-37" style="dashed=1;strokeColor=#999999" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1498" y="79" as="sourcePoint" />
            <mxPoint x="1500" y="1482" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-12" value="Rule A: PaymentSucceeded → OrderConfirmed が T_confirm 以内に来ない → Alert(P2)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#ff0000;fontColor=#ff0000;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="-151" y="103" width="1580" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-13" value="Rule B: OrderConfirmed → PaymentSucceeded が T_pay 以内に来ない → Alert(P2)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#ff0000;fontColor=#ff0000;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="-151" y="503" width="1486" height="40" as="geometry" />
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-14" value="Rule C: 同一 orderId で PaymentSucceeded が複数回 → 即 Alert(P1)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#ff0000;fontColor=#ff0000;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="-151" y="903" width="1580" height="40" as="geometry" />
        </mxCell>

        <!-- Rule A -->
        <mxCell id="cBfdUd4junJDnaiCbnr2-15" value="Webhook/Polling: PaymentSucceeded&#xa;(orderId=O-1)" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="374" y="183" as="sourcePoint" />
            <mxPoint x="144" y="183" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-16" value="produce PaymentSucceeded&#xa;ec-demo.payments.events.v1" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="144" y="233" as="sourcePoint" />
            <mxPoint x="604" y="233" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-17" value="consume + update state&#xa;set A deadline = now + T_confirm" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="283" as="sourcePoint" />
            <mxPoint x="844" y="283" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-18" value="... wait T_confirm ..." style="endArrow=open;dashed=1;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="333" as="sourcePoint" />
            <mxPoint x="844" y="333" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-19" value="Punctuator tick&#xa;deadline exceeded&#xa;OrderConfirmed missing" style="endArrow=block;html=1;dashed=1;strokeColor=#ff0000;fontColor=#ff0000" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="383" as="sourcePoint" />
            <mxPoint x="844" y="383" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-20" value="produce AlertRaised (A,P2)&#xa;ec-demo.alerts.order_payment_inconsistency.v1" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="433" as="sourcePoint" />
            <mxPoint x="604" y="433" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-38" value="consume AlertRaised&#xa;log orderId/alertId/rule/severity" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="463" as="sourcePoint" />
            <mxPoint x="1084" y="463" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-39" value="UPSERT ec_system.sys_pay_alert" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1084" y="493" as="sourcePoint" />
            <mxPoint x="1495" y="493" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Rule B -->
        <mxCell id="cBfdUd4junJDnaiCbnr2-21" value="注文確定/支払確定&#xa;(orderId=O-2)" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="-71" y="583" as="sourcePoint" />
            <mxPoint x="144" y="583" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-22" value="produce OrderStatusChanged&#xa;ec-demo.orders.events.v1" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="144" y="633" as="sourcePoint" />
            <mxPoint x="604" y="633" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-23" value="consume + update state&#xa;set B deadline = now + T_pay" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="683" as="sourcePoint" />
            <mxPoint x="844" y="683" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-24" value="... wait T_pay ..." style="endArrow=open;dashed=1;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="733" as="sourcePoint" />
            <mxPoint x="844" y="733" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-25" value="Punctuator tick&#xa;deadline exceeded&#xa;PaymentSucceeded missing" style="endArrow=block;html=1;dashed=1;strokeColor=#ff0000;fontColor=#ff0000" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="783" as="sourcePoint" />
            <mxPoint x="844" y="783" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-26" value="produce AlertRaised (B,P2)&#xa;ec-demo.alerts.order_payment_inconsistency.v1" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="833" as="sourcePoint" />
            <mxPoint x="604" y="833" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-40" value="consume AlertRaised&#xa;log orderId/alertId/rule/severity" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="863" as="sourcePoint" />
            <mxPoint x="1084" y="863" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-41" value="UPSERT ec_system.sys_pay_alert" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1084" y="893" as="sourcePoint" />
            <mxPoint x="1498" y="893" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Rule C -->
        <mxCell id="cBfdUd4junJDnaiCbnr2-27" value="Webhook: PaymentSucceeded #1&#xa;(orderId=O-3, paymentId=P-1)" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="374" y="983" as="sourcePoint" />
            <mxPoint x="144" y="983" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-28" value="produce PaymentSucceeded #1&#xa;ec-demo.payments.events.v1" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="144" y="1033" as="sourcePoint" />
            <mxPoint x="604" y="1033" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-29" value="consume + update state&#xa;paymentSuccessCount=1" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="1083" as="sourcePoint" />
            <mxPoint x="844" y="1083" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-30" value="Webhook: PaymentSucceeded #2&#xa;(orderId=O-3, paymentId=P-2)" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="374" y="1143" as="sourcePoint" />
            <mxPoint x="144" y="1143" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-31" value="produce PaymentSucceeded #2&#xa;ec-demo.payments.events.v1" style="endArrow=block;html=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="144" y="1193" as="sourcePoint" />
            <mxPoint x="604" y="1193" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-32" value="consume + update state&#xa;count=2 → Rule C" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="1243" as="sourcePoint" />
            <mxPoint x="844" y="1243" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-33" value="produce AlertRaised (C,P1)&#xa;ec-demo.alerts.order_payment_inconsistency.v1" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="844" y="1293" as="sourcePoint" />
            <mxPoint x="604" y="1293" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-42" value="consume AlertRaised&#xa;log orderId/alertId/rule/severity" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="604" y="1323" as="sourcePoint" />
            <mxPoint x="1084" y="1323" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="cBfdUd4junJDnaiCbnr2-43" value="UPSERT ec_system.sys_pay_alert" style="endArrow=block;html=1;strokeColor=#ff0000;fontColor=#ff0000" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1084" y="1353" as="sourcePoint" />
            <mxPoint x="1494" y="1359" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
