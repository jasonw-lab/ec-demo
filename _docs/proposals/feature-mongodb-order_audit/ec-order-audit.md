# ec-demo MongoDB 要件定義（order_audit）

## 1. ユースケース概要
本要件は、ec-demo において **注文ライフサイクル監査ログ（Order Timeline / Audit）** を実現するためのものである。

- 注文の現在状態は RDB（MySQL 等）で管理する  
- 注文の状態遷移履歴（証跡・監査ログ）は MongoDB で管理する  
- MongoDB は「履歴・説明責任」のために限定利用する  

---

## 2. 目的（Why）
- 注文が **なぜ・いつ・どのように** 現在の状態に至ったかを後から説明可能にする
- 障害調査、CS 対応、監査対応を想定した設計とする
- RDB の正データと履歴データを明確に分離する

---

## 3. ユースケース（What）
- 注文作成、決済成功/失敗、在庫引当、キャンセルなど  
  **注文状態が変化するたびに、その履歴を MongoDB に追記保存する**
- 特定の注文IDを指定して、状態遷移のタイムラインを取得できる

---

## 4. 対象外（Non-goals）
- MongoDB を注文の正データとして使用しない
- 高度な分析・検索機能は本要件では扱わない
- MongoDB トランザクションは使用しない

---

## 5. データ要件（Data Requirements）

### 5.1 コレクション
- コレクション名：`order_audit`（命名は既存規約に合わせて調整可）

### 5.2 データモデル
- **1注文 = 1ドキュメント**
- ドキュメント内に **状態遷移の履歴配列（history）** を保持する
- 主キーは `orderId`（`_id = orderId` としてもよい）

### 5.3 サンプルデータ
```json
{
  "orderId": "ORD-1001",
  "currentStatus": "PAID",
  "history": [
    {
      "status": "CREATED",
      "at": "2026-01-01T10:01",
      "by": "order-svc"
    },
    {
      "status": "PAID",
      "at": "2026-01-01T10:03",
      "by": "payment-svc",
      "eventId": "evt-123"
    }
  ]
}
```

### 5.4 必須フィールド
- orderId：注文ID
- currentStatus：現在の注文状態
- history：状態遷移の配列
- createdAt / updatedAt：作成・更新日時

### 5.5 history 要素の要件
- status：遷移後の状態
- at（occurredAt）：イベント発生時刻
- by（sourceService）：状態を変更したサービス
- eventId：イベント一意ID（冪等性確保用）
- metadata：任意の追加情報（任意）

---

## 6. 振る舞い要件（Behavior）

### 6.1 追記方式
- 履歴は **append-only（追記のみ）**
- 既存の履歴は更新・削除しない

### 6.2 冪等性
- 同一 eventId のイベントが再送された場合：
  - 履歴は追加しない
  - 処理は成功として扱う

---

## 7. 責務分離（重要）

### 7.1 書き込み責務
- MongoDB（order_audit）への書き込みは  
  **Order サービス（注文を統括するコンポーネント）のみ**が行う
- 決済・在庫など他サービスは、状態変化を通知する役割に専念する

### 7.2 データストアの役割分担
| データ内容 | ストア | 役割 |
|---|---|---|
| 注文の現在状態 | RDB | 正（トランザクション） |
| 状態遷移の履歴 | MongoDB | 証跡・監査 |

---

## 8. API 要件（Interface）

### 8.1 履歴取得
- 特定注文IDのタイムラインを取得できる
- 例：`GET /orders/{orderId}/timeline`

### 8.2 履歴追記（内部用）
- 状態遷移イベントを渡して履歴を追記できる
- 実装方式（REST / 内部メソッド）は既存設計に合わせて選択する

---

## 9. 非機能・運用要件

### 9.1 インデックス
- 主なアクセスは orderId のみ
- 追加する場合は `updatedAt`（管理・調査用）のみ
- 配列フィールドへの過剰なインデックスは作成しない

### 9.2 保守性
- シンプルで理解しやすい実装を優先する
- 書き込み競合や複雑なロックを避ける

---

## 10. 受け入れ条件（Acceptance Criteria）
- 注文IDを指定して履歴が取得できる
- 状態遷移イベントを追記できる
- 同一 eventId の再送でも履歴が重複しない
- MongoDB は履歴用途に限定されている

---

## 11. 一文まとめ
ec-demo では、注文の正データは RDB で管理し、  
状態遷移の履歴は MongoDB に append-only で保存する。
