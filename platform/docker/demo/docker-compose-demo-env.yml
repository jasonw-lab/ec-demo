networks:
  ec-demo-net:
    external: true
    # 実際に接続するDocker network名（例: docker_youlai-boot）
    name: ${EC_DEMO_NETWORK:-docker_youlai-boot}

services:
  # MySQL for ec-demo
  ec-demo-mysql:
    image: mysql:8.0.29
    # platform: ${EC_DEMO_PLATFORM:-linux/amd64}
    container_name: ec-demo-mysql-8
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: "123456"
      MYSQL_ROOT_HOST: "%"
      TZ: Asia/Tokyo
      LANG: en_US.UTF-8
    command: ["mysqld", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_general_ci"]
    volumes:
      - ./sql/mysql-init:/docker-entrypoint-initdb.d
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/mysql/conf/my.cnf:/etc/my.cnf
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/mysql/data:/var/lib/mysql
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/mysql/log:/var/log/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - ec-demo-net

  # Seata Server for ec-demo
  ec-demo-seata-server:
    image: seataio/seata-server:2.0.0
    # platform: ${EC_DEMO_PLATFORM:-linux/amd64}
    container_name: ec-demo-seata-server-2.0
    ports:
      - "7092:7091"   # console
      - "8091:8091"   # seata server
    environment:
      - TZ=${TZ:-Asia/Shanghai}
      - STORE_MODE=db
      - SEATA_IP=ec-demo-seata-server
      - SEATA_PORT=8091
    volumes:
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/seata/conf/application.yml:/seata-server/resources/application.yml:ro
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/seata/logs:/root/logs/seata
    restart: unless-stopped
    networks:
      - ec-demo-net
    depends_on:
      ec-demo-mysql:
        condition: service_healthy

  ec-demo-kafka:
    image: confluentinc/cp-kafka:latest
    container_name: ec-demo-kafka
    ports:
      - "29092:29092"
    environment:
      # KRaft mode settings
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@ec-demo-kafka:29093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

      # Listeners configuration
      # PLAINTEXT: コンテナ間通信用 (ec-demo-kafka:9092)
      # PLAINTEXT_HOST: ホストからのアクセス用 (HOST_IP環境変数でカスタマイズ可能、デフォルト: localhost)
      KAFKA_LISTENERS: PLAINTEXT://ec-demo-kafka:9092,PLAINTEXT_HOST://0.0.0.0:29092,CONTROLLER://ec-demo-kafka:29093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://ec-demo-kafka:9092,PLAINTEXT_HOST://${HOST_IP:-localhost}:29092,CONTROLLER://ec-demo-kafka:29093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Topic configuration
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CREATE_TOPICS: "ec-demo.orders.events.v1:1:1"
    volumes:
      - ec-demo-kafka-data:/var/lib/kafka/data
    restart: unless-stopped
    networks:
      - ec-demo-net

  ec-demo-kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: ec-demo-kafka-ui
    depends_on:
      - ec-demo-kafka
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: ec-demo
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: ec-demo-kafka:9092
    restart: unless-stopped
    networks:
      - ec-demo-net

#  ec-demo-redis:
#    image: redis:7.2-alpine
#    container_name: ec-demo-redis
#    ports:
#      - "6379:6379"
#    command: ["redis-server", "--appendonly", "yes"]
#    volumes:
#      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/redis/data:/data
#    restart: unless-stopped
#    networks:
#      - ec-demo-net

  ec-demo-elasticsearch:
    # kuromoji / icu / ingest-attachment を組み込んだカスタムES
    build:
      context: .
      dockerfile: Dockerfile.elasticsearch
      args:
        ES_IMAGE: ${ELASTICSEARCH_IMAGE:-docker.elastic.co/elasticsearch/elasticsearch:9.0.0}
    platform: ${EC_DEMO_PLATFORM:-linux/amd64}
    container_name: ec-demo-elasticsearch9
    restart: unless-stopped

    environment:
      - TZ=Asia/Tokyo
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms${ES_HEAP:-1g} -Xmx${ES_HEAP:-1g}

    ports:
      - "${ES_HTTP_PORT:-9200}:9200"
      - "${ES_TRANSPORT_PORT:-9300}:9300"

    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

    volumes:
      # ⚠ disk watermark 対策：ホストの空き容量 10%以上必須
      - ec-demo-elasticsearch-data:/usr/share/elasticsearch/data

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS 'http://127.0.0.1:9200/_cluster/health?wait_for_status=yellow&timeout=5s' >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 60

    networks:
      - ec-demo-net

  ec-demo-kibana:
    image: ${KIBANA_IMAGE:-docker.elastic.co/kibana/kibana:9.0.0}
    platform: ${EC_DEMO_PLATFORM:-linux/amd64}
    container_name: ec-demo-kibana9
    restart: unless-stopped

    depends_on:
      ec-demo-elasticsearch:
        condition: service_healthy

    environment:
      - TZ=Asia/Tokyo
      - SERVER_NAME=ec-demo-kibana
      - SERVER_HOST=0.0.0.0
      - ELASTICSEARCH_HOSTS=http://ec-demo-elasticsearch:9200
      - xpack.security.enabled=false
      # SavedObjects migration / Chromium対策
      - NODE_OPTIONS=--max-old-space-size=2048

    ports:
      - "${KIBANA_PORT:-5601}:5601"

    networks:
      - ec-demo-net

  # =========================
  # MinIO (stable, version pinned)
  # =========================
  ec-demo-minio:
    image: minio/minio:RELEASE.2024-12-13T22-19-12Z
    platform: ${EC_DEMO_PLATFORM:-linux/amd64}
    container_name: ec-demo-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - TZ=Asia/Tokyo
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin123}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/minio/data:/data
    networks:
      - ec-demo-net

  # =========================
  # es-service (Elasticsearch API)
  # =========================
  ec-demo-es-service:
    build:
      context: ../../..
      dockerfile: apps/services/es-service/Dockerfile
    platform: ${EC_DEMO_PLATFORM:-linux/amd64}
    container_name: ec-demo-es-service
    restart: unless-stopped
    depends_on:
      ec-demo-elasticsearch:
        condition: service_healthy
      ec-demo-minio:
        condition: service_started
    environment:
      - ELASTICSEARCH_ENDPOINT=http://ec-demo-elasticsearch:9200
      - ES_INDEX_NAME=${ES_INDEX_NAME:-products_v1}
      - ES_INDEX_ALIAS=${ES_INDEX_ALIAS:-products}
      - MINIO_ENDPOINT=http://ec-demo-minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin123}
      - MINIO_BUCKET=${MINIO_BUCKET:-ec-demo}
      - MINIO_PUBLIC_BASE_URL=${MINIO_PUBLIC_BASE_URL:-http://localhost:9000}
    ports:
      - "8084:8084"
    volumes:
      - ${EC_DEMO_IMPORT_DIR:-/tmp/ec-demo-import}:/data/import:ro
    networks:
      - ec-demo-net

  # MongoDB 6.0 LTS for ec-demo
  ec-demo-mongodb:
    image: mongo:6.0
    container_name: ec-demo-mongodb-6
    ports:
      - "27017:27017"
    environment:
      - TZ=Asia/Tokyo
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-admin123}
      - MONGO_INITDB_DATABASE=ec_demo
    volumes:
      - ./sql/mongodb-init:/docker-entrypoint-initdb.d:ro
      - ${EC_DEMO_BASEPATH:-/mydata/ec-demo}/mongodb/data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - ec-demo-net

volumes:
  ec-demo-elasticsearch-data:
  ec-demo-kafka-data:
