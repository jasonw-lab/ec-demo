# 创建一个名为 "youlai-boot" 的桥接网络，在同一个网络中的容器可以通过容器名互相访问
networks:
  youlai-boot:
    driver: bridge

services:
  mysql:
    image: mysql:8.0.29
    container_name: youlai-mysql
    restart: unless-stopped # 重启策略：除非手动停止容器，否则自动重启
    environment:
      - TZ=Asia/Tokyo
      - LANG= en_US.UTF-8
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD} #设置 root 用户的密码
      - MYSQL_DATABASE=nacos_config #创建 nacos_config 数据库
    volumes:
      - /mydata/mysql/conf/my.cnf:/etc/my.cnf # 挂载 my.cnf 文件到容器的指定路径
      - /mydata/mysql/data:/var/lib/mysql # 持久化 MySQL 数据
      - /mydata/mysql/log:/var/log/mysql #日志文件目录挂载
      - /mydata/sql/mysql:/docker-entrypoint-initdb.d # 初始化 SQL 脚本目录
    ports:
      - 3306:3306
    networks:
      - youlai-boot # 加入 "youlai-boot" 网络
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10

  nacos:
    image: nacos/nacos-server:v2.2.3 # 使用 Nacos 2.2.3 镜像
    container_name: youlai-nacos-server
    restart: unless-stopped # 重启策略：除非手动停止容器，否则自动重启
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos_config
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${NACOS_MYSQL_PASSWORD}
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=Asia/Tokyo
      - NACOS_AUTH_ENABLE=false
      - JVM_XMS=512m
      - JVM_XMX=512m
      - JVM_XMN=256m
      - MYSQL_DATABASE_NUM=1
      - NACOS_DATABASE=nacos_config
      - MYSQL_SERVICE_DB_INIT=true
    volumes:
      - /mydata/nacos/logs:/home/nacos/logs
      - /mydata/nacos/init.d:/home/nacos/init.d
    ports:
      - 8848:8848
      - 9848:9848
    networks:
      - youlai-boot # 加入 "mall" 网络
    depends_on:
      mysql:
        condition: service_healthy # 保证 MySQL 服务先启动且健康检查通过

  seata:
    image: seataio/seata-server:1.7.1
    container_name: youlai-seata-server
    restart: unless-stopped #  指定了容器的重启策略，除了手动停止容器，其他情况都自动重启容器
    environment:
      - STORE_MODE=db
      - SEATA_IP=youlai-seata-server
      - SEATA_PORT=8091
    volumes:
      - /mydata/seata/config:/seata-server/resources
      - /mydata/seata/logs:/root/logs/seata
    ports:
      - 8091:8091
      - 7091:7091
    networks:
      - youlai-boot
    depends_on:
      - nacos

  redis:
    image: redis:7.2.3
    container_name: youlai-redis
    restart: unless-stopped
    command: redis-server /etc/redis/redis.conf --requirepass ${REDIS_PASSWORD} --appendonly no # 启动 Redis 服务并添加密码，默认不开启 Redis AOF 方式持久化配置
    environment:
      - TZ=Asia/Tokyo
    volumes:
      - /mydata/redis/data:/data
      - /mydata/redis/config/redis.conf:/etc/redis/redis.conf
    ports:
      - 6379:6379
    networks:
      - youlai-boot

  minio:
    image: minio/minio:latest
    container_name: youlai-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - 9000:9000
      - 9001:9001
    environment:
      - TZ=Asia/Tokyo
      - LANG=en_US.UTF-8
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - /mydata/minio/data:/data
      - /mydata/minio/config:/root/.minio
    networks:
      - youlai-boot

  rabbitmq:
    image: rabbitmq:management
    container_name: youlai-rabbitmq
    restart: unless-stopped
    environment:
      - TZ=Asia/Tokyo
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    ports:
      - 5672:5672
      - 15672:15672
    networks:
      - youlai-boot # 加入 "mall" 网络

  xxl-job-admin:
    image: xuxueli/xxl-job-admin:2.4.0
    container_name: youlai-xxl-job-admin
    restart: unless-stopped
    environment:
      PARAMS: '--spring.datasource.url=jdbc:mysql://mysql:3306/xxl_job?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Tokyo --spring.datasource.username=root --spring.datasource.password=${XXL_JOB_MYSQL_PASSWORD} --spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver'
    volumes:
      - /mydata/xxljob/logs:/data/applogs
    ports:
      - 8080:8080
    networks:
      - youlai-boot
#
#  retail-app:
#    build:
#      context: ..
#      dockerfile: Dockerfile
#    container_name: youlai-retail-app
#    restart: unless-stopped
#    environment:
#      - TZ=Asia/Tokyo
#      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/mall_retail?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Tokyo
#      - SPRING_DATASOURCE_USERNAME=root
#      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
#      - SPRING_REDIS_HOST=redis
#      - SPRING_REDIS_PORT=6379
#      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
#      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR=nacos:8848
#      - SPRING_CLOUD_NACOS_CONFIG_SERVER-ADDR=nacos:8848
#      - SPRING_RABBITMQ_HOST=rabbitmq
#      - SPRING_RABBITMQ_PORT=5672
#      - SPRING_RABBITMQ_USERNAME=${RABBITMQ_DEFAULT_USER}
#      - SPRING_RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS}
#      - MINIO_ENDPOINT=http://minio:9000
#      - MINIO_ACCESSKEY=${MINIO_ROOT_USER}
#      - MINIO_SECRETKEY=${MINIO_ROOT_PASSWORD}
#    ports:
#      - 8989:8989
#    networks:
#      - youlai-boot
#    depends_on:
#      - mysql
#      - redis
#      - nacos
#      - minio
#      - rabbitmq
#      - xxl-job-admin


  nginx:
    image: nginx:stable-alpine
    container_name: youlai-nginx
    restart: unless-stopped
    volumes:
      - /mydata/nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - /mydata/nginx/conf/conf.d:/etc/nginx/conf.d
      - /mydata/nginx/html:/usr/share/nginx/html
      - /mydata/nginx/logs:/var/log/nginx
    ports:
      - 80:80
      - 443:443
    networks:
      - youlai-boot
    # Removed dependency on retail-app as it's commented out
    # depends_on:
    #   - retail-app
